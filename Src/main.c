#ifdef STM32
/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */


#include <neopixelDriver.h>
#include "system.h"
#include "core.h"
#include "systemClock.h"
#include "uart.h"
#include "consoleHandler.h"
#include "apiHandler.h"
#include "bufferedInputHandler.h"
#include "colorInterpolator.h"
#include "interpolators.h"
#include "stringFunctions.h"
#include "taskManager.h"


RGBStream lampsdata[N_LAMPS];
RGBStream * lamps = lampsdata;
uint32_t clr_cnt = 0;
uint32_t bit_cnt = 0;

uint8_t rawdata[N_LAMPS*24+1];
uint8_t* rawdata_ptr = rawdata;

TaskType interpolatorsArray[N_LAMPS];
TasksType interpolators;


volatile uint32_t task;
volatile uint8_t context;

extern CommBufferType usbCommBuffer;
extern CommBufferType btCommBuffer;

/*
 * updates the color along a hue shift with the phase going from 0 to 1535
 * */
void colorUpdate(RGB * color,uint32_t phase)
{
	if (phase < 0x100)
	{
		color->r = 0xFF;
		color->g = phase & 0xFF;
		color->b = 0x00;
	}
	else if (phase < 0x200)
	{
		color->r = 0x1FF - phase;
		color->g = 0xFF;
		color->b = 0x00;
	}
	else if (phase < 0x300)
	{
		color->r = 0x00;
		color->g = 0xFF;
		color->b = phase - 0x200;
	}
	else if (phase < 0x400)
	{
		color->r = 0x00;
		color->g = 0x3FF - phase;
		color->b = 0xFF;
	}
	else if (phase < 0x500)
	{
		color->r = phase - 0x400;
		color->g = 0x00;
		color->b = 0xFF;
	}
	else
	{
		color->r = 0xFF;
		color->g = 0x00;
		color->b = 0x5FF - phase;
	}
}


int main(void)
{
	uint8_t tasksDone = 1;
	ConsoleType usbConsole;
	ConsoleType btConsole;
	ApiType usbApi;
	ApiType btApi;
	BufferedInputType usbInput;
	BufferedInputType btInput;

	enableFpu();
    setupClock();

    initConsole(&usbConsole);
    initConsole(&btConsole);
    initApi(&usbApi);
    initApi(&btApi);

    usbInput.api = &usbApi;
    usbInput.console = &usbConsole;
    usbInput.commBuffer=&usbCommBuffer;
    usbInput.interfaceType=BINPUT_TYPE_CONSOLE;

    btInput.api = &btApi;
    btInput.console = &btConsole;
    btInput.commBuffer=&btCommBuffer;
    btInput.interfaceType=BINPUT_TYPE_CONSOLE;

	initTimer();
	initUart();
	initBTUart();

	context |= (1 << CONTEXT_USB) | (1 << CONTEXT_BT);
	printf("initializing color interpolators\r\n");

	interpolators.taskArray=(TaskType*)interpolatorsArray;
	interpolators.taskArrayLength=N_LAMPS;
	initInterpolators(&interpolators);

	/*
	setLampInterpolator(&interpolators,0,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 0,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 0,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 0,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 0,3);

	setLampInterpolator(&interpolators,1,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,14,INTERPOLATION_LINEAR, 1,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 1,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 1,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 1,3);

	setLampInterpolator(&interpolators,2,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 2,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 6,INTERPOLATION_LINEAR, 2,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 2,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 2,3);

	setLampInterpolator(&interpolators,3,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 3,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 3,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 13,INTERPOLATION_LINEAR, 3,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 3,3);

	setLampInterpolator(&interpolators,4,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 4,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 4,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 4,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 28,INTERPOLATION_LINEAR, 4,3);

	setLampInterpolator(&interpolators,5,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,15,INTERPOLATION_LINEAR, 5,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 5,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 5,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 5,3);

	setLampInterpolator(&interpolators,6,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 6,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 7,INTERPOLATION_LINEAR, 6,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 6,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 6,3);

	setLampInterpolator(&interpolators,7,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 7,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 7,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 14,INTERPOLATION_LINEAR, 7,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 7,3);

	setLampInterpolator(&interpolators,8,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 8,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 8,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 8,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 29,INTERPOLATION_LINEAR, 8,3);

	setLampInterpolator(&interpolators,9,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,17,INTERPOLATION_LINEAR, 9,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 9,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 9,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 9,3);

	setLampInterpolator(&interpolators,10,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 10,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 9,INTERPOLATION_LINEAR, 10,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 10,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 10,3);

	setLampInterpolator(&interpolators,11,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 11,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 11,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 16,INTERPOLATION_LINEAR, 11,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 11,3);

	setLampInterpolator(&interpolators,12,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 12,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 12,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 12,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 31,INTERPOLATION_LINEAR, 12,3);

	setLampInterpolator(&interpolators,13,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,19,INTERPOLATION_LINEAR, 13,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 13,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 13,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 13,3);

	setLampInterpolator(&interpolators,14,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 14,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 11,INTERPOLATION_LINEAR, 14,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 14,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 14,3);

	setLampInterpolator(&interpolators,15,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 15,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 15,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 18,INTERPOLATION_LINEAR, 15,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 15,3);

	setLampInterpolator(&interpolators,16,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 16,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 16,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 16,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 33,INTERPOLATION_LINEAR, 16,3);

	setLampInterpolator(&interpolators,17,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,21,INTERPOLATION_LINEAR, 17,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 17,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 17,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 17,3);


	setLampInterpolator(&interpolators,18,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 18,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 13,INTERPOLATION_LINEAR, 18,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 12,INTERPOLATION_LINEAR, 18,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 18,3);

	setLampInterpolator(&interpolators,19,4,MODE_REPEATING); // lamp 10, 4 steps, repeating
	setColorFramesInterpolation(&interpolators, 0,0,0 ,13,INTERPOLATION_LINEAR, 19,0);
	setColorFramesInterpolation(&interpolators, 0,255,0, 5,INTERPOLATION_LINEAR, 19,1);
	setColorFramesInterpolation(&interpolators, 0,45,130, 20,INTERPOLATION_LINEAR, 19,2);
	setColorFramesInterpolation(&interpolators, 200,200,200, 27,INTERPOLATION_LINEAR, 19,3);
*/



	startInterpolators(&interpolators);

	/**
	 * set initial color upon start
	 */
	for (uint8_t c=0;c<N_LAMPS;c++)
	{
		lamps[c].rgb.r = 245;
		lamps[c].rgb.g = 140;
		lamps[c].rgb.b = 40;
	}


	setSendState(SEND_STATE_RTS);


	printf("BallLamp v1.0 running\r\n");

    /* Loop forever */
	for(;;)
	{

		if (getSendState()==SEND_STATE_RTS)//(READY_TO_SEND)
		{
			sendToLed(); // non-blocking, returns long before the neopixel clock pulses have been sent
			tasksDone = 0;
		}

		if ((task & (1 << TASK_USB_CONSOLE))==(1 << TASK_USB_CONSOLE))
		{
			context = (1 << CONTEXT_USB);
			processInputBuffer(&usbInput);
			task &= ~(1 << TASK_USB_CONSOLE);
		}

		if ((task & (1 << TASK_BT_CONSOLE))==(1 << TASK_BT_CONSOLE))
		{
			context = (1 << CONTEXT_BT);
			processInputBuffer(&btInput);
			task &= ~(1 << TASK_BT_CONSOLE);
		}
		/*
		 * Time slot for handling tasks
		 */
		if (tasksDone == 0)
		{
			for(uint8_t c=0;c<interpolators.taskArrayLength;c++)
			{
				if ((interpolators.taskArray[c].state & 0x3) != TASK_STATE_STOPPED)
				{
					updateTask(&interpolators.taskArray[c],lamps);
				}
			}
			tasksDone=1;
		}

		// if the tasks are finished after the fps time has elapsed the next frame doesn't show
		// the correct data due to a buffer underrun
		if(getSendState()==SEND_STATE_BUFFER_UNDERRUN)
		{
			// potential error handling
			context |= (1 << CONTEXT_USB) | (1 << CONTEXT_BT);
			printf("BufferUnderrun!!\r\n");
		}

		if (getSendState()==SEND_STATE_SENT || getSendState()==SEND_STATE_BUFFER_UNDERRUN)// is in wait state after after the data transfer
		{
			decompressRgbArray(lamps,N_LAMPS);
		}

		sendCharAsyncUsb();
		sendCharAsyncBt();

	}
}
#endif
